# Фильтрация данных

- [Фильтрация данных](#фильтрация-данных)
  - [Используемая база данных](#используемая-база-данных)
  - [Операторы AND и OR](#операторы-and-и-or)
    - [Оператор AND](#оператор-and)
    - [Оператор OR](#оператор-or)
    - [Порядок обработки операторов](#порядок-обработки-операторов)
  - [Оператор IN](#оператор-in)
  - [Оператор NOT](#оператор-not)
  - [Оператор NOT IN](#оператор-not-in)
  - [Примечания](#примечания)
    - [Примечание 1](#примечание-1)
    - [Причемание 2](#причемание-2)

## Используемая база данных

Перед тем как приступить к теме урока, рассмотрим базу данных, которая будет использоваться в последующих примерах. Она состоит из одной таблицы с именем `Songs`, которая содержит информацию о пяти наиболее популярных песнях на некоторой площадке для прослушивания музыки:

```sql
+----+----------+----------------------+------------+---------+--------------+
| id | place    | trackname            | artist     | streams | release_date |
+----+----------+----------------------+------------+---------+--------------+
| 1  | 4        | Crazy On You         | Heart      | 76338   | 1976-03-01   |
| 2  | 3        | My Lover             | The Sounds | 99488   | 2009-05-31   |
| 3  | 2        | Running up That Hill | Kate Bush  | 121495  | 1985-08-05   |
| 4  | 5        | Thrill               | The Sounds | 49345   | 2016-11-10   |
| 5  | 1        | Spent the Day in Bed | Morrissey  | 174994  | 2017-09-19   |
+----+----------+----------------------+------------+---------+--------------+
```

Первое поле таблицы содержит идентификатор песни, второе — позицию песни в топе, третье — название песни, четвертое — псевдоним исполнителя или название группы, пятое — количество прослушиваний, шестое — дату выхода.

Скрипт для создания таблицы `Songs`:

```sql
DROP TABLE IF EXISTS Songs;
CREATE TABLE Songs
(
    id           INT PRIMARY KEY AUTO_INCREMENT,
    place        INT,
    trackname    VARCHAR(30),
    artist       VARCHAR(30),
    streams      INT,
    release_date DATE
);

INSERT INTO Songs (place, trackname, artist, streams, release_date)
VALUES (4, 'Crazy On You', 'Heart', 76338, '1976-03-01'),
       (3, 'My Lover', 'The Sounds', 99488, '2009-05-31'),
       (2, 'Running up That Hill', 'Kate Bush', 121495, '1985-08-05'),
       (5, 'Thrill', 'The Sounds', 49345, '2016-11-10'),
       (1, 'Spent the Day in Bed', 'Morrissey', 174994, '2017-09-19');
```

## Операторы AND и OR

Фильтрация данных при их извлечении не ограничивается лишь одним критерием. В `SQL`, как и во многих других языках программирования, можно использовать несколько условий, чтобы создавать более сложные фильтры. Для этого предназначены логические операторы `AND` и `OR`.

### Оператор AND

Чтобы отфильтровать данные по нескольким полям, необходимо воспользоваться оператором `AND`. Он используется для извлечения только тех записей, которые удовлетворяют **всем** указанным условиям.

Результатом приведенного ниже запроса:

```sql
SELECT trackname, artist, streams, release_date
FROM Songs
WHERE streams > 50000 AND release_date >= '2000-01-01';
```

является:

```sql
+----------------------+------------+---------+--------------+
| trackname            | artist     | streams | release_date |
+----------------------+------------+---------+--------------+
| My Lover             | The Sounds | 99488   | 2009-05-31   |
| Spent the Day in Bed | Morrissey  | 174994  | 2017-09-19   |
+----------------------+------------+---------+--------------+
```

> Количество условий после оператора `WHERE` может быть больше двух, в таком случае каждое из них должно отделяться отдельным оператором `AND`.

### Оператор OR

Действие оператора `OR` противоположно действию оператора `AND`. Он говорит о том, что должны быть извлечены только те записи, которые удовлетворяют хотя бы одному условию.

Результатом приведенного ниже запроса:

```sql
SELECT trackname, artist
FROM Songs
WHERE artist = 'Heart' OR artist = 'Kate Bush';
```

является:

```sql
+----------------------+-----------+
| trackname            | artist    |
+----------------------+-----------+
| Crazy On You         | Heart     |
| Running up That Hill | Kate Bush |
+----------------------+-----------+
```

> В большинстве СУБД при использовании оператора `OR` второе условие не рассматривается, если выполняется первое.

### Порядок обработки операторов

После оператора `WHERE` может содержаться любое количество логических операторов `AND` и `OR`. Комбинируя их, можно создавать сложные фильтры. Однако при комбинировании операторов `AND` и `OR` возникает одна проблема. Для ее понимания рассмотрим запрос, который, как кажется на первый взгляд, извлекает данные о песнях, исполнителями которых являются `The Sounds` или `Kate Bush` и количество прослушиваний которых превышает `50000`.

Результатом приведенного ниже запроса:

```sql
SELECT trackname, artist, streams
FROM Songs
WHERE artist = 'The Sounds' OR artist = 'Kate Bush' AND streams > 50000;
```

является:

```sql
+----------------------+------------+---------+
| trackname            | artist     | streams |
+----------------------+------------+---------+
| My Lover             | The Sounds | 99488   |
| Running up That Hill | Kate Bush  | 121495  |
| Thrill               | The Sounds | 49345   |
+----------------------+------------+---------+
```

Как видно по результирующей таблице, записи были отфильтрованы не так, как нужно, так как количество прослушиваний последней песни в результирующей таблице не превышает `50000`. Произошло это потому, что сперва обрабатывается логический оператор `AND`, а потом уже — логический оператор `OR`. Таким образом, приведенный выше запрос извлекает песни, исполненные `Kate Bush`, количество прослушиваний которых превышает `50000`, и песни, исполненные `The Sounds`, независимо от количества их прослушиваний.

> Чтобы составить корректный запрос, необходимо воспользоваться **скобками** и точно сгруппировать необходимые условия. В нашем случае в скобки нужно заключить часть условия с оператором `OR`, чтобы она имела больший приоритет и выполнялась первой.

Результатом приведенного ниже запроса:

```sql
SELECT trackname, artist, streams
FROM Songs
WHERE (artist = 'The Sounds' OR artist = 'Kate Bush') AND streams > 50000;
```

является:

```sql
+----------------------+------------+---------+
| trackname            | artist     | streams |
+----------------------+------------+---------+
| My Lover             | The Sounds | 99488   |
| Running up That Hill | Kate Bush  | 121495  |
+----------------------+------------+---------+
```

> При использовании логических операторов `AND` и `OR` рекомендуется всегда ставить скобки, чтобы точно сгруппировать условия. Не стоит полагаться на порядок обработки по умолчанию, даже если он подразумевает необходимый результат.

## Оператор IN

Оператор `IN` позволяет определить, совпадает ли значение поля с одним из перечисленных значений.

Результатом приведенного ниже запроса:

```sql
SELECT trackname, artist
FROM Songs
WHERE artist IN ('Heart', 'Kate Bush', 'Morrissey');
```

является:

```sql
+----------------------+-----------+
| trackname            | artist    |
+----------------------+-----------+
| Crazy on You         | Heart     |
| Running up That Hill | Kate Bush |
| Spent the Day in Bed | Morrissey |
+----------------------+-----------+
```

> Однако оператор `IN` имеет некоторое преимущество перед оператором `OR`. Например, при работе с большим количеством значений синтаксис логического оператора `IN` гораздо понятнее. Также при использовании оператора `IN` совместно с операторами `AND` и `OR` намного легче управлять порядком их обработки.

## Оператор NOT

Логический оператор `NOT` служит только одной цели — отрицать условие, следующее за ним. Например, с помощью данного оператора мы можем извлечь данные о тех песнях, исполнителем которых не является группа `The Sounds`.

Результатом приведенного ниже запроса:

```sql
SELECT trackname, artist
FROM Songs
WHERE NOT artist = 'The Sounds';
```

является:

```sql
+----------------------+-----------+
| trackname            | artist    |
+----------------------+-----------+
| Crazy on You         | Heart     |
| Running up That Hill | Kate Bush |
| Spent the Day in Bed | Morrissey |
+----------------------+-----------+
```

Однако в более сложных условиях можно воспользоваться оператором `NOT` в связке с оператором `IN`, что окажется предпочтительнее оператора `!=`.

Результатом приведенного ниже запроса:

```sql
SELECT trackname, artist
FROM Songs
WHERE NOT artist IN ('Heart', 'Kate Bush', 'Morrissey');
```

является:

```sql
+-----------+------------+
| trackname | artist     |
+-----------+------------+
| My Lover  | The Sounds |
| Thrill    | The Sounds |
+-----------+------------+
```

## Оператор NOT IN

Связка операторов `NOT` и `IN` хоть и довольно полезна, но недостаточно наглядна. На практике для определения несоответствия списку значений используется более очевидный оператор `NOT IN`, выполняющий ровно то же, что и связка операторов `NOT` и `IN`.

Результатом приведенного ниже запроса:

```sql
SELECT trackname, artist
FROM Songs
WHERE artist NOT IN ('Heart', 'Kate Bush', 'Morrissey');
```

является:

```sql
+-----------+------------+
| trackname | artist     |
+-----------+------------+
| My Lover  | The Sounds |
| Thrill    | The Sounds |
+-----------+------------+
```

## Примечания

### Примечание 1

Логические операторы `AND`, `OR`, `NOT`, `IN` и `NOT IN` имеют разный приоритет. В таблице ниже они представлены в порядке уменьшения их приоритета:

| Оператор |
| -------- |
| IN , NOT IN |
| NOT |
| AND |
| OR |

Если условие содержит несколько логических операторов с одинаковым приоритетом, они выполняются слева направо.

### Причемание 2

Логический оператор `NOT` отрицает только то условие, перед которым указан.

Результатом приведенного ниже запроса:

```sql
SELECT id, artist
FROM Songs
WHERE NOT id = 1 OR id = 2;
```

является:

```sql
+----+------------+
| id | artist     |
+----+------------+
| 2  | The Sounds |
| 3  | Kate Bush  |
| 4  | The Sounds |
| 5  | Morrissey  |
+----+------------+
```

В запросе выше указано два условия, но оператор `NOT` отрицает только первое из них. Для того, чтобы он отрицал все условия, необходимо объединить их вместе с помощью круглых скобок.

Результатом приведенного ниже запроса:

```sql
SELECT id, artist
FROM Songs
WHERE NOT (id = 1 OR id = 2);
```

является:

```sql
+----+------------+
| id | artist     |
+----+------------+
| 3  | Kate Bush  |
| 4  | The Sounds |
| 5  | Morrissey  |
+----+------------+
```
