# Создание вычисляемых полей

- [Создание вычисляемых полей](#создание-вычисляемых-полей)
  - [Используемая база данных](#используемая-база-данных)
  - [Вычисляемые поля](#вычисляемые-поля)
  - [Объединение значений полей](#объединение-значений-полей)
    - [Функция CONCAT()](#функция-concat)
    - [Функция CONCAT\_WS()](#функция-concat_ws)
  - [Выполнение математических вычислений](#выполнение-математических-вычислений)

## Используемая база данных

Перед тем как приступить к теме урока, рассмотрим базу данных, которая будет использоваться в последующих примерах. Она состоит из одной таблицы с именем `Songs`, которая содержит информацию о пяти наиболее популярных песнях на некоторой площадке для покупки и прослушивания музыки:

```sql
+----+-------+----------------------+------------+-------+----------+
| id | place | trackname            | artist     | price | quantity |
+----+-------+----------------------+------------+-------+----------+
| 1  | 4     | Crazy On You         | Heart      | 2.00  | 31454    |
| 2  | 3     | My Lover             | The Sounds | 3.00  | 4558     |
| 3  | 2     | Running up That Hill | Kate Bush  | 1.00  | 15874    |
| 4  | 5     | Thrill               | The Sounds | 5.00  | 548      |
| 5  | 1     | Spent the Day in Bed | Morrissey  | 5.00  | 564797   |
+----+-------+----------------------+------------+-------+----------+
```

Первое поле этой таблицы содержит идентификатор песни, второе — позицию песни в топе, третье — название песни, четвертое — псевдоним исполнителя или название группы, пятое — цену песни в долларах, шестое — количество проданных копий.

Скрипт для создания таблицы `Songs`:

```sql
DROP TABLE IF EXISTS Songs;
CREATE TABLE Songs
(
    id        INT PRIMARY KEY AUTO_INCREMENT,
    place     INT,
    trackname VARCHAR(30),
    artist    VARCHAR(30),
    price     DECIMAL(10, 2),
    quantity  INT
);

INSERT INTO Songs (place, trackname, artist, price, quantity)
VALUES (4, 'Crazy On You', 'Heart', 2.00, 31454),
       (3, 'My Lover', 'The Sounds', 3.00, 4558),
       (2, 'Running up That Hill', 'Kate Bush', 1.00, 15874),
       (5, 'Thrill', 'The Sounds', 5.00, 548),
       (1, 'Spent the Day in Bed', 'Morrissey', 5.00, 564797);
```

## Вычисляемые поля

Данные, хранимые в таблицах базы данных, часто бывают представлены не в том виде, в котором они необходимы. Например, в таблице, хранящей персональные данные людей, имя и фамилия человека могут находиться в разных полях, однако нам может потребоваться указать их в одном поле. Другим примером может являться таблица, хранящая детали интернет-заказа. В одном поле таблицы может находиться количество приобретенного товара, в другом — цена за единицу товара. Во время работы с такой таблицей закономерно может понадобиться общая стоимость — цена товара, умноженная на количество.

В каждом из рассмотренных примеров перед нами встает задача получения информации, которая не хранится в базе данных в явном виде, однако может быть получена путем различных манипуляций. Для решения подобной задачи используются **вычисляемые поля** — поля, значения которых не хранятся в таблице базы данных, а вычисляются автоматически на основе данных из других полей таблицы. Вычисляемые поля используются для извлечения информации с дополнительными преобразованиями, подсчетами или форматированием.

## Объединение значений полей

### Функция CONCAT()

Наиболее простым примером вычисляемого поля является поле, которое содержит объединение значений из нескольких полей таблицы.

> Операцию объединения или склеивания нескольких значений часто называют конкатенацией. Например, конкатенацией строк `bee` и `geek` является строка `beegeek`.

В SQL для объединения нескольких значений используется функция `CONCAT()`. Она принимает переменное количество аргументов, выполняет их конкатенацию и возвращает полученный результат. Результатом функции `CONCAT()` всегда является строка, однако аргументы функции могут принадлежать любым типам, поскольку функция неявно преобразует все аргументы в строки перед объединением.

Возвращаясь к предложенному примеру, воспользуемся функцией `CONCAT()` и напишем запрос, который извлекает названия песен и их исполнителей, причем указывает эти данные в одном поле.

Результатом приведенного ниже запроса:

```sql
SELECT CONCAT(artist, ' - ', trackname)
FROM Songs;
```

является:

```sql
+----------------------------------+
| CONCAT(artist, ' - ', trackname) |
+----------------------------------+
| Heart - Crazy On You             |
| The Sounds - My Lover            |
| Kate Bush - Running up That Hill |
| The Sounds - Thrill              |
| Morrissey - Spent the Day in Bed |
+----------------------------------+
```

### Функция CONCAT_WS()

Для конкатенации значений в SQL существует дополнительная функция — `CONCAT_WS()`. В отличие от функции `CONCAT()`, она не только объединяет значения, но и добавляет между ними разделитель. Разделитель указывается в качестве первого аргумента, объединяемые значения — в качестве всех остальных.

Результатом приведенного ниже запроса:

```sql
SELECT CONCAT_WS(', ', id, artist, trackname) AS song
FROM Songs;
```

является:

```sql
+------------------------------------+
| song                               |
+------------------------------------+
| 1, Heart, Crazy On You             |
| 2, The Sounds, My Lover            |
| 3, Kate Bush, Running up That Hill |
| 4, The Sounds, Thrill              |
| 5, Morrissey, Spent the Day in Bed |
+------------------------------------+
```

> Функция `CONCAT_WS()`, как и функция `CONCAT()`, умеет работать с аргументами любых типов, поскольку перед объединением неявно преобразует все аргументы в строки.

## Выполнение математических вычислений

Как было упомянуто в начале урока, с помощью вычисляемых полей можно решать задачи, требующие выполнения математических операций над извлекаемыми данными.

Например, структура нашей таблицы Songs такова, что в ней для каждой песни указана цена, а также количество проданных копий. Общей суммы, которую принесли продажи каждой песни, в таблице нет, однако она может быть получена путем умножения цены песни на количество проданных копий. В качестве примера напишем запрос, который выполняет именно такую операцию и определяет общую сумму, которую принесли продажи каждой песни.

Результатом приведенного ниже запроса:

```sql
SELECT artist, trackname,
       price * quantity AS revenue
FROM Songs;
```

является:

```sql
+------------+----------------------+------------+
| artist     | trackname            | revenue    |
+------------+----------------------+------------+
| Heart      | Crazy On You         | 62908.00   |
| The Sounds | My Lover             | 13674.00   |
| Kate Bush  | Running up That Hill | 15874.00   |
| The Sounds | Thrill               | 2740.00    |
| Morrissey  | Spent the Day in Bed | 2823985.00 |
+------------+----------------------+------------+
```

> В SQL поддерживаются основные математические операторы: `+` (сложение), `-` (вычитание), `*` (умножение) и `/` (деление). Для управления порядком обработки операторов можно использовать круглые скобки.
